---
title: "Testing R Functions Automatically"
teaching: 30
exercises: 10
questions:
- "What is the benefit of auto-testing my functions?"
- "How do I create and run test-cases in R?"
- "Why would I change my code after I got it to run?"
objectives:
- "Formalise documented examples as tests."
- "Use testthat functions to create and run tests."
keypoints:
- "Tests help you ensure correct code."
source: Rmd
---

```{r, include = FALSE}
source("../bin/chunk-options.R")
knitr_fig_path("04-testthat-")
```

### Auto-testing functions with the `testthat` package

Computer code evolves. As you just saw, functions need to be updated
when new use-cases appear, or new goals need to be achieved, or
sped up when more data needs to be crunched, or cleaned up to make their code
more readable for collaborators, reviewers, etc. You probably know the saying
"Never change a running system!" We surely invested a lot of time already to make
sure our functions work fine now. It is natural to be cautious about changing
computer code and it rightly shouldn't be done on a whim.

However, as you have probably learned in the Git lesson, branching is one way to
try out code changes in a way that allows you to recover from a mistake, and only
merge successful changes. Automatic tests are another way to "span a safety net",
and in R, the [`testthat` package][testthat] is commonly used. Install it through
RStudio's `Packages` panel or execute `install.packages("testthat")` in the console.

> ## Loading packages in RStudio or the console
>
> Checking and unticking a box in RStudio's `Packages` panel is the same as
> executing `library("…")` and `detach("…")` in the console. Note how your mouse
> interaction with the panel sends commands, or how your console commands affect
> the panel. The same is true for `install.packages()` and `remove.packages()`.
{: .callout}

A `testthat` case is composed of the following elements:

```{r center-test}
library("testthat")
test_that("centering works", { # function call with a descriptive string
  expect_equal(                # expectation, which compares…
    object = center(data = c(1, 2, 3), desired = 0), # … the function's actual output…
    expected = c(-1, 0, 1)                           # … with our expected result
  )
})
```

Don't worry that there is no output when you execute one or more `expect_equal()`
statement(s), or  the whole `test_that()` block. In good UNIX
tradition, `testthat` will only bother you in case some expectations are _not_
met, i.e. one or more unit tests fail.

> ## Adding more test-cases
>
> When we tested our `rescale()` function interactively, we used several different
> numeric examples. Search your script and/or your console history in RStudio to
> find these examples and convert them into more `expect_equal(…)` test-cases.


> ## Testing our rescaling functions
>
> Apply the above example of converting the examples into unit tests in the
> `rescale.R` file as well.
>
> > ## Solution
> > ~~~
> > library("testthat")
> > test_that("rescaling works", {
> >   expect_equal(rescale(c(1, 2, 3)), c(0.0, 0.5, 1.0))
> >   expect_equal(rescale(c(1, 2, 3, 4, 5)), c(0.0, 0.25, 0.5, 0.75, 1.0))
> > })
> > ~~~
> > {: .r}
> {: .solution}
> 
> Think about the [DRY principle]({{ page.root }}/03-func-R/#composing-functions).
> Is it necessary to keep the `@examples` in the documentation when you are using
> them in the tests, or vice versa? Which considerations would help you decide?
>
> > ## Hint
> > 
> > Examples are a good starting point, but: Tests help you ensure semantically,
> > mathematically and scientifically correct code. This may require covering
> > edge-cases, errors, etc. with dedicated tests. These may not be helpful,
> > instructive examples for your users. The examples should teach how  your
> > functions can be applied to solve your users' problems.
> {: .solution}
{: .challenge}

In order to get very quick feedback on your code, consider activating RStudio's
`Source on Save` function and getting used to pressing <kbd>Ctrl</kbd>+<kbd>S</kbd>
whenever you think your code is ready to be saved. If there are any errors, read
the error message, investigate and correct either your code or the test and
<kbd>Ctrl</kbd>+<kbd>S</kbd> again.

Once all your tests are green, a good moment has come to also commit your tests
for `center.R` and `rescale.R`. Pick a self-explanatory commit message ;-)
