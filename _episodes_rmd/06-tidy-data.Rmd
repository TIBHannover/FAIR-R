---
title: "Tidying & packaging datasets"
teaching: 30
exercises: 10
questions:
- "What are possible forms that a dataset can have?"
- "What advantages and disadvantages do these forms have?"
- "Which features make a dataset more or less reusable?"
- "How can we add datasets to R packages?"
objectives:
- "Use `tidyr::gather()` to convert wide data to its long form."
keypoints:
- "Spreadsheets incentivise the wide data format, which may spread variables across columns."
source: Rmd
---

```{r, include = FALSE}
source("../bin/chunk-options.R")
knitr_fig_path("06-tidy-data-R-")
```

## Tidying our inflammation datasets

In the preparations episode, we read in, visualised, centered and rescaled a
dataset about inflammation in 60 patients measured over 40 days. Let's pretend
we need to tidy it up for further publication alongside the package we have been
constructing.

First, run `library(usethis)` and `use_data_raw()` and note the `Next:` instructions
in the console. In particular, copy the `inflammation-*.csv` files to `data-raw`
and start a `tidy-inflammation.R` file there to which you add the necessary lines
of the following code examples. Think about which of them are purely for interactive
checks of the tidying process. You needn't save those to "data creation scripts".

```{r inflammation-wide}
dat <- read.csv(file = "inflammation-01.csv", header = FALSE)
head(colnames(dat), 10)
head(rownames(dat), 10)
```

You probably noticed that neither "patients" nor "days" is listed anywhere. Thus,
we should label the data first, starting with pseudonyms for the patients. If
this were real data from real human patients, we would have acquired their written
and informed consent to the pseudonymous data publication before collecting it,
and during approval of our study by the ethics committee. We would also have 
pre-registered our study, e.g. on [AllTrials.net](http://www.alltrials.net/).

```{r inflammation-label}
patient_ID <- paste("patient", sep = "_", seq(60))
dat_labelled <- cbind(dat, patient_ID)
head(dat_labelled)
```

Now we have labelled our observations with `patient_ID` as the column/variable
name and `patient_â€¦` as the values. Next we are going to "gather" the observations,
meaning that we:

1. define `day` as the common `key` of all the `V1`, `V2`, etc. variables, 
1. define a name for the newly created column, in which the `value`s from the
   messy variables will be gathered, and
1. specify which variables we want to gather into key-value pairs.

```{r inflammation-gather}
dat_long <- tidyr::gather(dat_labelled,
                         key = "day",
                         value = "inflammation_score",
                         V1:V40)
tail(dat_long)
```

Notice the row numbers? Because we gathered observations into one column, and thus one
observation per row, the `r nrow(dat_long)` rows now are the product of the
initial `r nrow(dat)` rows and `r ncol(dat)` columns.

Because the days shouldn't remain labelled with `V`s, we also convert them to
numbers. This works with either `as.factor()` and `as.numeric()` after another,
or nested: 

```{r inflammation-days}
dat_long$day <- as.numeric(as.factor(dat_long$day))
str(dat_long)
```

The structure of our inflammation dataset is now a lot tidier than before and we
can finally package it up in an R-supported format. Rename the dataframe to some-
thing more self-descriptive than `dat...`, using for example
`inflammation_scores <- dat_long` and then run `use_data(inflammation_scores)`.

## Documenting datasets

Just as a good function documentation makes your code more accessible and reusable
for others and your future self, datasets benefit from a documentation as well.
Please read through [r-pkgs.had.co.nz/data.html#documenting-data](http://r-pkgs.had.co.nz/data.html#documenting-data)
and keep in mind, that the descriptive tags for datasets are not entirely the
same as the those for function documentation.
```
